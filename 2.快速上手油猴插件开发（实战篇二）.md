# çŸ¥ä¹ç›®å½•ï¼ˆzhihu-helperï¼‰

## ä¸€ã€**æˆå“å±•ç¤º**

![demo1](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/demo1.gif)

å®‰è£…åœ°å€ï¼š

1. å®‰è£…[æ²¹çŒ´æ’ä»¶](https://chrome.google.com/webstore/detail/tampermonkey-beta/gcalenpjmijncebpfijmoaglllgpjagf?hl=zh-CN) ï¼ˆå¦‚æœå®‰è£…è¿‡åˆ™ä¸ç”¨å†å®‰ï¼‰
2. å®‰è£… [zhihu-helper](https://greasyfork.org/zh-CN/scripts/421238-zhihu-helper)

ä»£ç åœ°å€ï¼š[wokoo/zhihu-helper](https://github.com/kinyaying/wokoo/tree/master/example/zhihu-helper)

## äºŒã€**å¼€å‘æ­¥éª¤**

### 1.1 é¡¹ç›®å®‰è£… & åˆå§‹åŒ–é…ç½®

```js
npm i wokoo -g
wokoo zhihu-help
```

é€‰æ‹©æ¨¡æ¿

- [ ] vue
- [ ] react

è¿™é‡Œé€‰æ‹©reactï¼Œç­‰å¾…é¡¹ç›®å®‰è£…ã€‚é¡¹ç›®å®‰è£…å®Œæˆåï¼Œæ ¹æ®æç¤ºæ‰§è¡Œä¸‹å‘½ä»¤ï¼š

```shell
cd zhihu-helper
npm start
```

- æ‰“å¼€æ²¹çŒ´è„šæœ¬ç¼–è¾‘å™¨ï¼ŒæŠŠtampermonkey.jsçš„å†…å®¹å¤åˆ¶è¿›å»ã€‚

  ![tampermonkey](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/tampermonkey.png)

  ![copy-tampermonkey](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/copy-tampermonkey.png)

- æ‰“å¼€ç½‘é¡µ[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/mandy)ï¼Œå³ä¸Šè§’å‡ºç°ä¸€åªçŒ´å­å›¾æ ‡ï¼Œè¯´æ˜é¡¹ç›®å·²è·‘é€šã€‚

### 1.2 å¼€å‘åŸºæœ¬åŠŸèƒ½

æ•´ç†æ€è·¯

1. ç»˜åˆ¶å·¦ä¾§æŠ½å±‰å¼¹çª—
2. å¼¹çª—å¼¹å‡ºæ—¶è¯·æ±‚çŸ¥ä¹åˆ—è¡¨æ¥å£ï¼Œæ‹¿åˆ°åˆ—è¡¨æ•°æ®
3. ä¸‹æ‹‰æ—¶å®ç°åŠ è½½æ›´å¤šçš„åŠŸèƒ½

ä¸‹é¢æˆ‘ä»¬æ¥é€æ­¥å®ç°å§~

**æ­¥éª¤1. ç»˜åˆ¶å·¦ä¾§æŠ½å±‰å¼¹çª—**

ä¸»è¦é€šè¿‡this.state.showæ§åˆ¶å¼¹çª—çš„æ˜¾ç¤ºéšè—ã€‚æ­¤æ­¥éª¤æŒºç®€å•çš„ï¼Œå¯ä»¥ç›´æ¥çœ‹ä»£ç :[step1](https://github.com/kinyaying/wokoo/blob/master/example/zhihu-helper/src/step1.js)ï¼Œå¯ä»¥å°†index.jså…¥å£é‡Œçš„appæ›¿æ¢æˆstep1æŸ¥çœ‹æ•ˆæœã€‚

**æ­¥éª¤2. è¯·æ±‚[çŸ¥ä¹åˆ—è¡¨](https://www.zhihu.com/api/v4/columns)æ¥å£ï¼Œè·å–åˆ—è¡¨æ•°æ®**

- å®‰è£…axiosï¼Œå¹¶å¼•å…¥

```shell
npm install axios
```

- è®¡ç®—è¯·æ±‚å‚æ•°

åˆ†æè¯·æ±‚çš„urlå¯çŸ¥ï¼Œè¯·æ±‚æ¥å£ä¸ºï¼š

```js
`https://www.zhihu.com/api/v4/columns${this.queryName}/items?limit=20&offset=${offset}`
```

å…¶ä¸­this.queryNameæ˜¯ä¸“æ åç§°ï¼Œå½“é¡µé¢ä¸º[ä¸“æ åˆ—è¡¨é¡µ](https://zhuanlan.zhihu.com/mandy)æ—¶å°±æ˜¯pathname; å½“é¡µé¢ä¸º[ä¸“æ è¯¦æƒ…é¡µ](https://zhuanlan.zhihu.com/p/348005704)æ—¶ï¼Œéœ€è¦é€šè¿‡ç±»åä¸º`ColumnPageHeader-TitleColumn`çš„aæ ‡ç­¾çš„hrefæ¥è·å–ã€‚

![zhihu](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/zhihu.png)

![zhihu1](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/zhihu1.png)

é€šè¿‡è¿™ä¸¤å¼ å›¾åº”è¯¥æ›´å¥½ç†è§£getQueryNameæ–¹æ³•

```js
getQueryName = () => {
    let pathname = location.pathname
    let detailRegExp = /^\/p\/\d+/
    let queryName = ''
    // ä¸“æ è¯¦æƒ…é¡µ
    if (detailRegExp.test(pathname)) {
      let aTage = document.getElementsByClassName(
        'ColumnPageHeader-TitleColumn'
      )
      let url = aTage[0].href
      queryName = url.slice(url.lastIndexOf('/'))
    } else {
      // ä¸“æ åˆ—è¡¨é¡µ
      // http://zhuanlan.zhihuå’Œhttp://zhihu/columnä¸¤ç§æƒ…å†µéƒ½æ˜¯ä¸“æ 
      if (pathname.indexOf('/column') === 0) {
        pathname = pathname.slice('/column'.length)
      }
      queryName = pathname
    }
    this.queryName = queryName
  }
```

è€Œåˆ—è¡¨é¡µåˆå­˜åœ¨ä¸¤ç§åŸŸåï¼šhttps://www.zhihu.com/column/mandy    å’Œ https://zhuanlan.zhihu.com/mandy  æ‰€ä»¥åœ¨`else`é€»è¾‘é‡Œé’ˆå¯¹`https://www.zhihu.com/column/mandy  `åšäº†å¤„ç†ï¼Œåªä¿ç•™/mandy

é€šè¿‡getQueryNameæ–¹æ³•ï¼Œæˆ‘ä»¬è·å–åˆ°äº†è¯·æ±‚å‚æ•°

- å‘é€è¯·æ±‚ï¼Œæ‹‰å–ç›®å½•åˆ—è¡¨

```js
getList = async () => {
    if (!this.state.hasMore) return
    let { offset } = this.state
    let { data } = await axios.get(
      `https://www.zhihu.com/api/v4/columns${this.queryName}/items?limit=20&offset=${offset}`
    )
    let list = data.data.map((i) => ({
      title: i.title,
      url: i.url,
      id: i.id,
      commentCount: i.comment_count,
      voteupCount: i.voteup_count,
    }))
    if (data.paging.is_end) {
      this.setState({ hasMore: false })
    }
    offset += limit

    this.setState({
      list: [...this.state.list, ...list],
      offset,
    })
  }
```

ç¬¬äºŒæ­¥çš„è¿‡ç¨‹å®ç°å®Œäº†ï¼Œä»£ç åœ¨è¿™é‡ŒğŸ‘‰[step2](https://github.com/kinyaying/wokoo/blob/master/example/zhihu-helper/src/step2.js) ï¼Œå¯ä»¥å°†index.jså…¥å£é‡Œçš„appæ›¿æ¢æˆstep2æŸ¥çœ‹æ•ˆæœã€‚

è¿™æ—¶æ’ä»¶çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼Œé™¤äº†æ²¡æœ‰ä¸‹æ‹‰åŠ è½½åŠŸèƒ½ï¼Œå…¶ä»–åŸºæœ¬å®Œå·¥äº†ã€‚

![image-20210206004837608](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/image-20210206004837608.png)



**æ­¥éª¤3. ä¸‹æ‹‰æ—¶å®ç°åŠ è½½æ›´å¤šçš„åŠŸèƒ½**

æ— é™æ»šåŠ¨çš„ç»„ä»¶å¼•äº†ç¬¬ä¸‰æ–¹åº“[react-infinite-scroll-component](https://www.npmjs.com/package/react-infinite-scroll-component)ï¼š

```shell
npm install react-infinite-scroll-component
```

ä¸»è¦æ˜¯åœ¨renderå‡½æ•°é‡Œå¢åŠ InfiniteScrollç»„ä»¶ï¼Œæ³¨æ„InfiniteScrollçš„heightéœ€è¦é€šè¿‡è®¡ç®—ç»™ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œå¦åˆ™æ— æ³•è§¦å‘æ»šåŠ¨ã€‚

```js
<ul className="list-ul" onMouseLeave={this.handleMouseLeave}>
  <InfiniteScroll
		dataLength={list.length}
		next={this.handleInfiniteOnLoad}
		hasMore={hasMore}
		loader={<h4>Loading...</h4>}
    height={document.documentElement.clientHeight - 53}
		endMessage={
  		<p style={{ textAlign: 'center' }}>
    		<b>åˆ°åº•äº†ï¼Œæ²¡å†…å®¹å•¦~</b>
			</p>
		}
  >
    {list.map((i) => (
      <li className="list-li" key={i.id}>
      ...
      </li>
))}
  </InfiniteScroll>
</ul>
```

æ­¤æ—¶åŠŸèƒ½å·²ç»å¼€å‘å®Œæˆï¼Œå…·ä½“ä»£ç æŸ¥çœ‹ ğŸ‘‰[app.js](https://github.com/kinyaying/wokoo/blob/master/example/zhihu-helper/src/app.js) 

## ä¸‰ã€éƒ¨ç½²æ’ä»¶åˆ°æ²¹çŒ´å•†åº—

**3.1 æ„å»º**

æ‰§è¡Œå‘½ä»¤

```shell
npm run build
```

**3.2 ç¡®è®¤æ²¹çŒ´è„šæœ¬æ–‡ä»¶tampermonkey.js**

æ­¤æ–‡ä»¶ä¸­è¢«æ³¨é‡Šæ‰çš„//@xxx éƒ½æœ‰å«ä¹‰ï¼Œå¯ä»¥å¯¹åº”ç€ [tampermonkeyå¼€å‘æ–‡æ¡£ ](https://www.tampermonkey.net/documentation.php?version=4.6&ext=dhdg) ç†è§£ã€‚

- @description æ’ä»¶æè¿°

- @match æŒ‡å®šæŸäº›åŸŸåä¸‹å¼€å¯æ­¤æ’ä»¶ï¼Œé»˜è®¤é…äº†ä¸¤æ¡ï¼Œ`// @match        https://*/*`å’Œ`// @match        https://*/*`è¡¨ç¤ºåœ¨æ‰€æœ‰åŸŸåä¸‹éƒ½å¼€å¯ã€‚ä½†æ˜¯æ­¤å¤„å¸Œæœ›åªåœ¨zhihuä¸“æ é‡Œä½¿ç”¨æ­¤æ’ä»¶ï¼Œæ‰€ä»¥è¦ä¿®æ”¹@mathå­—æ®µã€‚

  ```js
  // @match        https://zhuanlan.zhihu.com/*
  // @match        https://www.zhihu.com/column/*
  ```

- @require æ²¹çŒ´è„šæœ¬å†…éƒ¨å¸®å¿™å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºï¼Œæ¯”å¦‚jqueryï¼Œreactç­‰ã€‚

  ```js
  // @require https://unpkg.com/react@17/umd/react.production.min.js
  // @require https://unpkg.com/react-dom@17/umd/react-dom.production.min.js
  ```



**3.3 å‘å¸ƒæ’ä»¶åˆ°æ²¹çŒ´å¸‚åœº**

å‘å¸ƒæ²¹çŒ´å¸‚åœºçš„ä¼˜ç‚¹æ˜¯ä¸ç”¨å®¡æ ¸ï¼Œå³å‘å³ç”¨ï¼Œéå¸¸æ–¹ä¾¿ã€‚

1. å°†/dist/app.bundle.js æ–‡ä»¶éƒ¨ç½²åˆ° cdn ä¸Šï¼Œè·å–åˆ°å¯¹åº” urlã€‚

**æ³¨æ„ï¼š**

- jsæ–‡ä»¶å¯æ”¾åˆ° github ä¸Šï¼Œå¦‚æœæ‰˜ç®¡åˆ° github ä¸Šæœ€å¥½åš cdn åŠ é€Ÿï¼ˆæˆ‘ä½¿ç”¨cdn.jsdelivr.netè¿›è¡ŒcdnåŠ é€Ÿï¼‰ã€‚

- å¦‚æœæ²¡æœ‰cdnæœåŠ¡å™¨å¯è·³è¿‡æ­¤æ­¥éª¤ï¼Œåœ¨æ­¥éª¤4ç›´æ¥å°†app.bundle.jså¤åˆ¶åˆ°æ²¹çŒ´è„šæœ¬ç¼–è¾‘å™¨ä¸­

2. ç™»å½•[æ²¹çŒ´å¸‚åœº](https://greasyfork.org/)ï¼Œè°·æ­Œè´¦å·æˆ– github è´¦å·éƒ½å¯ä½¿ç”¨ã€‚

3. ç‚¹å‡»è´¦å·åç§°ï¼Œå†ç‚¹å‡»ã€Œå‘å¸ƒä½ ç¼–å†™çš„è„šæœ¬ã€

   ![wokoo-tamp3](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/wokoo-tamp3.png)

   ![wokoo-tamp4](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/wokoo-tamp4.png)

4. è¿›å…¥ç¼–è¾‘é¡µï¼Œå°† tampermonkey.js é‡Œçš„å†…å®¹å¤åˆ¶åˆ°ç¼–è¾‘æ¡†ä¸­

   æ³¨æ„ï¼š

   - æ­¥éª¤1ä¸­å¦‚æœæ‰˜ç®¡äº†cdnï¼Œéœ€è¦å°†ä»£ç ä¸­çš„`localhost:8080`ç½‘å€æ›¿æ¢æˆé™æ€èµ„æº url

   - æ­¥éª¤1ä¸­æ²¡æœ‰æ‰˜ç®¡cdnï¼Œä¸èƒ½ç›´æ¥å°†/dist/app.bundle.jsæ–‡ä»¶é‡Œçš„å†…å®¹å¤åˆ¶ç¼–è¾‘æ¡†ã€‚å› ä¸ºç¼–è¾‘æ¡†å†…ä»£ç æœ‰æœ€å¤§é™åˆ¶ï¼Œæˆ‘ä»¬æ„å»ºçš„app.bundle.jsæŠŠreactç­‰ä¸‰æ–¹åº“æ„å»ºè¿›å»è¶…è¿‡æœ€å¤§é™åˆ¶äº†ã€‚

     éœ€è¦å¯¹æ„å»ºç»“æœè¿›è¡Œæ‹†åŒ…

     4.1 ä¿®æ”¹  tampermonkey.js ï¼Œé€šè¿‡@requireæ–¹å¼å¼•å…¥reactå’Œreact-dom

     ```js
     // ==UserScript==
     // @name         zhihu-helper
     // @namespace    http://tampermonkey.net/
     // @version      0.0.1
     // @description  çŸ¥ä¹ç›®å½•
     // @author       xx
     // @match        https://zhuanlan.zhihu.com/*
     // @match        https://www.zhihu.com/column/*
     // @require https://unpkg.com/react@17/umd/react.production.min.js
     // @require https://unpkg.com/react-dom@17/umd/react-dom.production.min.js
     
     // ==/UserScript==
     
     // app.bundle.jsæ„å»ºå¥½çš„ä»£ç 
     ```

     4.2 ä¿®æ”¹webpack.config.base.jsçš„entryå­—æ®µ

     ```js
     entry: {
         app: '/src/index.js',
         vendor: [
           // å°†reactå’Œreact-domè¿™äº›å•ç‹¬æ‰“åŒ…å‡ºæ¥ï¼Œå‡å°æ‰“åŒ…æ–‡ä»¶ä½“ç§¯
           'react',
           'react-dom',
         ],
       },
     ```

     4.3 é‡æ–°æ‰§è¡Œ`npm run build` æ„å»ºå‡ºæ–°çš„app.bundle.jsï¼Œå¤åˆ¶åˆ°æ²¹çŒ´å¸‚åœºçš„ç¼–è¾‘æ¡†å†…ã€‚

     ![zhihu-tampermonkey](https://gitee.com/zhufengpeixun/browser-plugin/raw/master/img/zhihu-tampermonkey.png)

5. ç‚¹å‡» ã€Œå‘å¸ƒè„šæœ¬ã€å³å¯